<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css">
    <title>TripPlanner</title>
</head>

<body>
    <nav class="navbar sticky-top navbar-dark" style="background-color: #166649;">
        <div class="container-fluid">
            <a class="navbar-brand">TripPlanner</a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/logoff">Logout</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="page-container">
        <h1>Hi, <span data-th-text="${username}"></span></h1><br>
        <div style="width: 60%;">
            <h2>This is your dashboard. You can start finding public transport directions or check out your
                previous/favourite routes below.</h2>
        </div>

        <div class="card">
            <div class="card-header">
                Get Directions/Transport Information
            </div>
            <div class="card-body" style="max-width: 80%;">
                <h2 class="card-title">Enter a start and end location:</h2>
                <!-- <p class="card-text">With supporting text below as a natural lead-in to additional content.</p> -->
                <div th:if="${globalErrors}">
                    <ul>
                        <li class="error" th:each="error : ${globalErrors}" th:text="${error.defaultMessage}"></li>
                    </ul>
                </div>
                <span>Get my current location as origin:</span>
                <button onclick="getLocation()" type="button" class="btn btn-success"><svg
                        xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-geo"
                        viewBox="0 0.3 18 18">
                        <path fill-rule="evenodd"
                            d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6M4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.3 1.3 0 0 0-.37.265.3.3 0 0 0-.057.09V14l.002.008.016.033a.6.6 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.6.6 0 0 0 .146-.15l.015-.033L12 14v-.004a.3.3 0 0 0-.057-.09 1.3 1.3 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465s-2.462-.172-3.34-.465c-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411" />
                    </svg> Get My Location</button><br>
                <h2>or</h2>
                <form method="POST" action="/valid/getDirections" data-th-object="${req}">
                    <span>Search a Start Location*:</span><br>
                    <input id="autocomplete" type="text" placeholder="Search an origin location/address"
                        width="480px"><br>
                    <input type="hidden" id="olatitude" data-th-field="*{olatitude}">
                    <input type="hidden" id="olongitude" data-th-field="*{olongitude}">
                    <input type="hidden" id="oname" data-th-field="*{oName}">
                    <input type="hidden" id="ofora" data-th-field="*{oForA}">
                    <h2 class="card-title" id="formatted-address"></h2><br>

                    <span>Search an End Location*:</span><br>
                    <input id="destination" type="text" placeholder="Search a destination location/address"
                        width="480px"><br>
                    <input type="hidden" id="dlatitude" data-th-field="*{dlatitude}">
                    <input type="hidden" id="dlongtitude" data-th-field="*{dlongtitude}">
                    <input type="hidden" id="dname" data-th-field="*{dName}">
                    <input type="hidden" id="dfora" data-th-field="*{dForA}">
                    <h2 class="card-title" id="dformatted-address"></h2><br>

                    <h2 class="card-title">Please Enter Either*:</h2>
                    <span>Departure Time:</span><br>
                    <input type="datetime-local" data-th-field="*{depTime}"><br>
                    <h2 class="card-title">or</h2>
                    <span>Preferred Arrival Time:</span><br>
                    <input type="datetime-local" data-th-field="*{arrTime}"><br><br>

                    <span>Preferred travel options*:</span><br>
                    <select data-th-field="*{pref}" style="width: 240px; height: 28px;">
                        <option value="Less Walking">Less Walking</option>
                        <option value="Fewer Transfers">Fewer Transfers</option>
                    </select><br><br>

                    <span>Preferred transports:</span><br>
                    <small>(Multi-select possible)</small><br>
                    <input type="checkbox" data-th-field="*{transportModes}" value="Train" checked>
                    <span>Prefer Trains</span><br>
                    <input type="checkbox" data-th-field="*{transportModes}" value="Bus" checked>
                    <span>Prefer Buses</span><br><br>

                    <button class="btn btn-primary" type="submit">Get Directions</button>

                </form>
            </div>
            <div class="card-footer text-muted">
                * indicates mandatory
            </div>
        </div>

        <hr>
        <br>

        <div id="qv-container" data-th-if="${hasRoutes == true}">
            <h1>My List of Saved Routes:</h1>
            <table class="table">
                <thead>
                    <tr>
                        <th>Created On:</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Pref. Depart. & Arr. Time</th>
                        <th>Pref. Travel Options & Modes</th>
                        <th>Bus & Train Options</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-th-each="quickv : ${quickviews}" data-th-object="${quickv}">
                        <td data-th-text="*{createdOn}"></td>
                        <td data-th-text="*{originName}"></td>
                        <td data-th-text="*{destName}"></td>
                        <td data-th-text="*{prefTime}"></td>
                        <td>
                            <span data-th-text="*{prefTravelOp}"></span><br>
                            <span data-th-text="*{prefTransport}"></span>
                        </td>
                        <td>
                            Bus(es): <span data-th-text="*{buses}"
                                th:style="|color: ${buses == 'N/A' ? 'grey' : 'black'};|"></span><br>

                            Train(s): <span data-th-text="*{trainCodeAndName}"
                                th:style="|color: ${trainCodeAndName == 'N/A' ? 'grey' : 'black'};|"></span>
                        </td>
                        <td>
                            <a
                                th:href="@{/valid/{username}/route/{keyid}(username=${username}, keyid=${quickv.keyid})}">View</a><br>
                                <a
                                th:href="@{/valid/delete(id=${quickv.keyid}, username=${username})}" onclick="return confirmDelete(event, this)">Delete</a><br>
                        </td>
                    </tr>
                </tbody>
            </table><br>





        </div>






    </div>

    <script>
        function confirmDelete(event, link) {
            // Prevent the default link action
            event.preventDefault();
            
            // Ask for user confirmation
            const confirmation = confirm("Are you sure you want to delete this item?");
            
            if (confirmation) {
                // If confirmed, proceed with the link action
                window.location.href = link.href; // Redirect to the delete URL
            } else {
                // If cancelled, do nothing (keep user on the current page)
                return false;
            }
        }
        </script>




    <!-- LOAD GET LOCATION FUNCTIONS -->
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(sendLocation, showError);
            } else {
                document.getElementById("output").innerText = "Geolocation is not supported by this browser.";
            }
        }

        function sendLocation(position) {
            // Fill the form fields with latitude and longitude
            const lat = position.coords.latitude;
            const long = position.coords.longitude;
            document.getElementById("olatitude").value = lat;
            document.getElementById("olongitude").value = long;
            // Create the Geocoder object
            const geocoder = new google.maps.Geocoder();

            // Perform reverse geocoding
            geocoder.geocode({ location: { lat: parseFloat(lat), lng: parseFloat(long) } }, (results, status) => {
                if (status === "OK") {
                    if (results[0]) {
                        // Display the formatted address
                        console.log(results[0]);
                        const name = results[0].address_components[0].long_name;
                        const formattedaddress = results[0].formatted_address;
                        document.getElementById("formatted-address").innerText = "Your Current Location: " + name + " (" + formattedaddress + ")";
                        document.getElementById("oname").value = name;
                        document.getElementById("ofora").value = formattedaddress;
                        console.log("Formatted Address:", results[0].formatted_address);
                    } else {
                        alert("No results found for the provided coordinates.");
                    }
                } else {
                    alert("Geocoder failed due to: " + status);
                }
            });
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("output").innerText = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("output").innerText = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("output").innerText = "The request to get user location timed out.";
                    break;
                default:
                    document.getElementById("output").innerText = "An unknown error occurred.";
            }
        }
    </script>

    <!-- LOAD AUTOCOMPLETE FIELDS AND ITS FUNCTIONS -->
    <script>
        let autocomplete, destinationAutocomplete;

        // This function will be called once the Google Maps API is loaded
        function initAutocomplete() {
            // Get the input element
            const input = document.getElementById('autocomplete');
            const desinput = document.getElementById('destination');

            // Create an instance of Autocomplete attached to the input field
            autocomplete = new google.maps.places.Autocomplete(input);
            destinationAutocomplete = new google.maps.places.Autocomplete(desinput);


            const options = {

                componentRestrictions: { country: 'SG' }  // Restrict results to sg
            };

            autocomplete.setOptions(options);
            destinationAutocomplete.setOptions(options);

            // Add listener for place selection (when the user selects a suggestion)
            autocomplete.addListener('place_changed', onPlaceChanged);
            destinationAutocomplete.addListener('place_changed', onPlaceChangedDest);
        }

        // This function will be called when a user selects a place from the autocomplete suggestions
        function onPlaceChanged() {
            const place = autocomplete.getPlace();

            if (!place.geometry) {
                // If the selected place doesn't have geometry, return
                console.log("No details available for the input: '" + place.name + "'");
                return;
            }

            // Now, you can use the details of the selected place
            console.log('Selected place:', place);

            // For example, you can access the place's name, coordinates, and address
            const name = place.name;
            console.log("selected origin: " + name);
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            const formattedAddress = place.formatted_address;

            // Do something with this information (like display it on the page, map, etc.)
            document.getElementById("formatted-address").innerText = "Your Start Location: " + name + " (" + formattedAddress + ")";
            document.getElementById("olatitude").value = lat;
            document.getElementById("olongitude").value = lng;
            document.getElementById("oname").value = name;
            document.getElementById("ofora").value = formattedAddress;

        }

        function onPlaceChangedDest() {
            const place = destinationAutocomplete.getPlace();

            if (!place.geometry) {
                // If the selected place doesn't have geometry, return
                console.log("No details available for the input: '" + place.name + "'");
                return;
            }

            // Now, you can use the details of the selected place
            console.log('Selected place:', place);

            // For example, you can access the place's name, coordinates, and address
            const dname = place.name;
            console.log("selected destination: " + name);
            const lat = place.geometry.location.lat();
            const lng = place.geometry.location.lng();
            const dformattedAddress = place.formatted_address;


            // Do something with this information (like display it on the page, map, etc.)
            document.getElementById("dformatted-address").innerText = "Your End Location: " + dname + " (" + dformattedAddress + ")";
            document.getElementById("dlatitude").value = lat;
            document.getElementById("dlongtitude").value = lng;
            document.getElementById("dname").value = dname;
            document.getElementById("dfora").value = dformattedAddress;
        }
    </script>
    <script
        th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${key} + '&libraries=places&loading=async&callback=initAutocomplete'"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>